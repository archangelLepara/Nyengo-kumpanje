
require("dotenv").config();
const express = require("express");
const axios = require("axios");

const app = express();
app.use(express.json());

/* ===============================
   IN-MEMORY USER STORE (DEMO)
================================ */
let USERS = [];

/* ===============================
   FLOOD-PRONE DISTRICTS (MW)
================================ */
const FLOOD_PRONE = [
  "Nsanje", "Chikwawa", "Phalombe",
  "Balaka", "Mangochi", "Lower Shire"
];

/* ===============================
   SAFE ZONE (Lilongwe HQ)
================================ */
const SAFE_ZONE = { lat: -13.9833, lon: 33.7833 };

/* ===============================
   DISTANCE (KM)
================================ */
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(2);
}

/* ===============================
   FRONTEND (HTML + CSS + JS)
================================ */
app.get("/", (_, res) => {
res.send(`
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Malawi Disaster Safety</title>
<style>
body {
  font-family: Arial;
  background: linear-gradient(#0a3d62, #1e3799);
  color: white;
  padding: 20px;
}
.card {
  background: white;
  color: black;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
}
button {
  background: #e55039;
  color: white;
  border: none;
  padding: 12px;
  width: 100%;
  border-radius: 6px;
  font-size: 16px;
}
input {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}
.alert {
  background: #c0392b;
  padding: 10px;
  border-radius: 6px;
}
.hidden { display: none; }
</style>
</head>
<body>

<h2>ðŸ‡²ðŸ‡¼ Malawi Disaster Safety System</h2>

<div class="card" id="register">
<h3>Create Account (Required)</h3>
<input id="name" placeholder="Full Name">
<input id="email" placeholder="Email">
<input id="c1" placeholder="Family Contact 1">
<input id="c2" placeholder="Family Contact 2">
<input id="c3" placeholder="Family Contact 3">
<button onclick="register()">Create Account</button>
</div>

<div class="card hidden" id="app">
<h3>Check Weather Risk</h3>
<input id="area" placeholder="District / Area">
<button onclick="checkRisk()">Check Risk</button>

<div id="output"></div>
<div id="danger" class="hidden"></div>
</div>

<script>
let userEmail = null;

async function register() {
  userEmail = email.value;
  await fetch("/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: name.value,
      email: email.value,
      c1: c1.value, c2: c2.value, c3: c3.value
    })
  });
  document.getElementById("register").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
}

async function checkRisk() {
  navigator.geolocation.getCurrentPosition(async pos => {
    const res = await fetch("/risk", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: userEmail,
        area: area.value,
        lat: pos.coords.latitude,
        lon: pos.coords.longitude
      })
    });
    const data = await res.json();

    output.innerHTML = \`
      <p><b>Weather:</b> \${data.weather}</p>
      <p><b>Temperature:</b> \${data.temp} Â°C</p>
      <p><b>Distance to Safe Zone:</b> \${data.distance} km</p>
    \`;

    if (data.danger) {
      danger.classList.remove("hidden");
      danger.innerHTML = \`
        <div class="alert">
        âš  <b>DANGER DETECTED</b><br><br>
        \${data.advice}<br><br>
        <b>Emergency Numbers:</b><br>
        Police: <a href="tel:997">997</a><br>
        Ambulance: <a href="tel:998">998</a><br>
        Fire: <a href="tel:999">999</a><br><br>
        <b>Family Contacts:</b><br>
        \${data.contacts.join("<br>")}
        </div>
      \`;
    } else {
      danger.classList.add("hidden");
    }
  });
}
</script>
</body>
</html>
`);
});

/* ===============================
   REGISTER USER
================================ */
app.post("/register", (req, res) => {
  USERS.push(req.body);
  res.json({ success: true });
});

/* ===============================
   RISK CHECK
================================ */
app.post("/risk", async (req, res) => {
  const user = USERS.find(u => u.email === req.body.email);
  if (!user) return res.status(403).json({ error: "Not registered" });

  const weatherRes = await axios.get(
    "https://api.openweathermap.org/data/2.5/weather",
    {
      params: {
        q: req.body.area + ",MW",
        units: "metric",
        appid: process.env.OPENWEATHER_API_KEY
      }
    }
  );

  const flood = FLOOD_PRONE.some(d =>
    req.body.area.toLowerCase().includes(d.toLowerCase())
  );

  let advice = "";
  if (flood) {
    const ai = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4.1",
        messages: [{
          role: "user",
          content:
            "Flood risk in Malawi. Give urgent safety advice."
        }]
      },
      {
        headers: {
          Authorization: "Bearer " + process.env.OPENAI_API_KEY
        }
      }
    );
    advice = ai.data.choices[0].message.content;
  }

  res.json({
    weather: weatherRes.data.weather[0].description,
    temp: weatherRes.data.main.temp,
    distance: distanceKm(req.body.lat, req.body.lon, SAFE_ZONE.lat, SAFE_ZONE.lon),
    danger: flood,
    advice,
    contacts: [user.c1, user.c2, user.c3]
  });
});

/* ===============================
   START
================================ */
app.listen(process.env.PORT || 5000, () =>
  console.log("ðŸ‡²ðŸ‡¼ Malawi Disaster Safety System running")
);
