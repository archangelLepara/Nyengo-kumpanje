require("dotenv").config();
const express = require("express");
const axios = require("axios");

const app = express();
app.use(express.json());

/* =========================
   FLOOD-PRONE AREAS (MW)
========================= */
const FLOOD_PRONE = ["Nsanje", "Chikwawa", "Phalombe", "Balaka", "Lower Shire"];
const SAFE_POINT = { lat: -13.9833, lon: 33.7833 }; // Lilongwe (example safe zone)

/* =========================
   DISTANCE FUNCTION
========================= */
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(2);
}

/* =========================
   MAIN PAGE (HTML + JS)
========================= */
app.get("/", (req, res) => {
  res.send(`
<!DOCTYPE html>
<html>
<head>
<title>Malawi Weather & Safety</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; padding: 15px; }
input, button { padding: 10px; width: 100%; margin: 5px 0; }
.alert { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>ğŸ‡²ğŸ‡¼ Malawi Weather & Disaster Safety</h2>

<input id="area" placeholder="Enter District / Area">
<button onclick="checkWeather()">Check Weather</button>

<div id="result"></div>
<div id="ai"></div>

<h3>ğŸš¨ Emergency Numbers</h3>
<ul>
<li>ğŸ‘® Police: <a href="tel:997">997</a></li>
<li>ğŸš‘ Ambulance: <a href="tel:998">998</a></li>
<li>ğŸš’ Fire: <a href="tel:999">999</a></li>
</ul>

<h3>ğŸ›¡ï¸ Sign Up (3 Emergency Contacts)</h3>
<input id="name" placeholder="Name">
<input id="email" placeholder="Email">
<input id="c1" placeholder="Contact 1">
<input id="c2" placeholder="Contact 2">
<input id="c3" placeholder="Contact 3">
<button onclick="signup()">Register</button>

<script>
async function checkWeather() {
  const area = document.getElementById("area").value;

  navigator.geolocation.getCurrentPosition(async pos => {
    const res = await fetch("/weather", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        area,
        lat: pos.coords.latitude,
        lon: pos.coords.longitude
      })
    });

    const data = await res.json();

    document.getElementById("result").innerHTML = \`
      <h3>\${area}</h3>
      <p>\${data.desc}</p>
      <p>Temperature: \${data.temp}Â°C</p>
      \${data.flood ? "<p class='alert'>âš  FLOOD RISK</p>" : ""}
      <p>Distance to safe area: \${data.distance} km</p>
    \`;

    document.getElementById("ai").innerHTML =
      "<h3>AI Safety Advice</h3><p>" + data.advice + "</p>";
  });
}

async function signup() {
  await fetch("/signup", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: name.value,
      email: email.value,
      c1: c1.value,
      c2: c2.value,
      c3: c3.value
    })
  });
  alert("Registered successfully!");
}
</script>
</body>
</html>
`);
});

/* =========================
   WEATHER + AI ENDPOINT
========================= */
app.post("/weather", async (req, res) => {
  const { area, lat, lon } = req.body;

  const weather = await axios.get(
    "https://api.openweathermap.org/data/2.5/weather",
    {
      params: {
        q: area + ",MW",
        units: "metric",
        appid: process.env.OPENWEATHER_API_KEY
      }
    }
  );

  const flood = FLOOD_PRONE.some(a =>
    area.toLowerCase().includes(a.toLowerCase())
  );

  const dist = distanceKm(lat, lon, SAFE_POINT.lat, SAFE_POINT.lon);

  const ai = await axios.post(
    "https://api.openai.com/v1/chat/completions",
    {
      model: "gpt-4.1",
      messages: [{
        role: "user",
        content:
          "Weather: " + weather.data.weather[0].description +
          ". Flood risk: " + (flood ? "YES" : "NO") +
          ". Give Malawi safety advice."
      }]
    },
    {
      headers: {
        Authorization: "Bearer " + process.env.OPENAI_API_KEY
      }
    }
  );

  res.json({
    temp: weather.data.main.temp,
    desc: weather.data.weather[0].description,
    flood,
    distance: dist,
    advice: ai.data.choices[0].message.content
  });
});

/* =========================
   SIGNUP
========================= */
app.post("/signup", (req, res) => {
  console.log("USER REGISTERED:", req.body);
  res.json({ success: true });
});

/* =========================
   START SERVER
========================= */
app.listen(process.env.PORT || 5000, () =>
  console.log("ğŸ‡²ğŸ‡¼ Malawi Safety App running")
);
